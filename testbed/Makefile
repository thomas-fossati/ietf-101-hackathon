.DEFAULT_GOAL := help

NODES := $(shell docker-compose config --services | xargs)

up: config ; docker-compose up -d

build-up: config ; docker-compose up --build -d

down: ; docker-compose down

top: ; docker-compose top

# Dynamically create each sh-<node> rule
define interactive_shell_template
sh-$(1): ; docker exec -ti $(1) bash
endef

$(foreach node,$(NODES),$(eval $(call interactive_shell_template,$(node))))

# Create a window with tiles for each node (iTerm2 / MacOSX only)
iterms: up ; osascript utils/iterm2-interactive.scpt $(shell pwd)

help:
	@echo
	@echo "Available targets:"
	@echo
	@echo " * up            start the testbed"
	@echo " * build-up      build images before starting the testbed"
	@echo " * down          stop the testbed"
	@echo " * top           display running processes"
	@echo " * sh-<node>     start interactive shell on <node>"
	@echo "                 where <node> is one of: $(NODES)"
	@echo " * config        generate netemd configuration files"
	@echo " * clean         remove autogenerated config files"
	@echo


clean: clean-config

#
# Automatic generation of netemd configuration files
#
include .env


%.json: %.json.in
	@sed -e "s/@CLIENT_DOMAIN_ROUTER_ADDR@/${CLIENT_DOMAIN_ROUTER_ADDR}/" \
	     -e "s/@CLIENT_DOMAIN_CLIENT_ADDR@/${CLIENT_DOMAIN_CLIENT_ADDR}/" \
	     -e "s/@SERVER_DOMAIN_ROUTER_ADDR@/${SERVER_DOMAIN_ROUTER_ADDR}/" \
	     -e "s/@SERVER_DOMAIN_SERVER_ADDR@/${SERVER_DOMAIN_SERVER_ADDR}/" $< > $@

define autogen_config
etc/$(1)/netemd-config.json: etc/$(1)/netemd-config.json.in

AUTOGEN_CONFIGFILES += etc/$(1)/netemd-config.json
endef

$(foreach node,client server router,$(eval $(call autogen_config,$(node))))

config: $(AUTOGEN_CONFIGFILES)

clean-config: ; $(RM) $(AUTOGEN_CONFIGFILES)

.PHONY: up build-up down iterms top config clean clean-config
